# yamllint disable-file
{{/*
ConfigMap for Dynamo optimization settings
Includes KV cache, routing, and worker pool configuration
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dynamo-vllm.fullname" . }}-config
  namespace: {{ include "dynamo-vllm.namespace" . }}
  labels:
    {{- include "dynamo-vllm.labels" . | nindent 4 }}
data:
  dynamo-config.yaml: |
    # Dynamo Optimization Settings
    # Auto-generated by Helm chart
    
    # KV Cache Configuration
    kv_cache:
      enabled: {{ .Values.dynamoConfig.kvCache.enabled }}
      max_size_gb: {{ .Values.dynamoConfig.kvCache.maxSizeGb }}
      eviction_policy: {{ .Values.dynamoConfig.kvCache.evictionPolicy }}
    
    # Routing Configuration
    routing:
      algorithm: {{ .Values.dynamoConfig.routing.algorithm }}
      kv_weight: {{ .Values.dynamoConfig.routing.kvWeight }}
      load_weight: {{ .Values.dynamoConfig.routing.loadWeight }}
    
    # Worker Pool Configuration
    worker_pool:
      health_check_interval: {{ .Values.dynamoConfig.workerPool.healthCheckInterval }}
      health_check_timeout: {{ .Values.dynamoConfig.workerPool.healthCheckTimeout }}
      max_retries: {{ .Values.dynamoConfig.workerPool.maxRetries }}
    
    # Worker Registry (each worker = one model)
    workers:
      {{- range $worker := .Values.workers }}
      - name: {{ $worker.name }}
        model: {{ $worker.model.path }}
        type: {{ $worker.workerType | default "both" }}
        replicas: {{ $worker.replicas | default 1 }}
        gpu_device: {{ $worker.gpuDevice }}
        tensor_parallel_size: {{ $worker.model.tensorParallelSize | default 1 }}
      {{- end }}
