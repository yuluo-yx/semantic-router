---
# SemanticRouter with Milvus Cache Backend
# This example demonstrates how to configure the semantic router to use Milvus for caching
# Milvus provides enterprise-grade, scalable vector database with advanced features
apiVersion: vllm.ai/v1alpha1
kind: SemanticRouter
metadata:
  name: semantic-router-milvus
  namespace: default
spec:
  replicas: 1

  # Configure vLLM backend endpoints
  vllmEndpoints:
    - name: llama-model
      model: llama3-70b
      reasoningFamily: qwen3
      backend:
        type: service
        service:
          name: vllm-llama
          port: 8000

  # Persistence for model cache
  persistence:
    enabled: true
    size: 10Gi

  # Basic resource limits
  resources:
    requests:
      cpu: 2000m
      memory: 4Gi
    limits:
      cpu: 4000m
      memory: 8Gi

  # Semantic router configuration
  config:
    # BERT model for embeddings (required for semantic cache)
    bert_model:
      model_id: models/mom-embedding-light
      threshold: "0.6"
      use_cpu: true

    # Semantic cache with Milvus backend
    semantic_cache:
      enabled: true
      backend_type: milvus
      similarity_threshold: "0.90"
      ttl_seconds: 7200
      embedding_model: bert  # Using BERT for this example

      # Milvus configuration
      # NOTE: Update host to match your Milvus deployment namespace
      milvus:
        connection:
          host: milvus-standalone.cache-backends.svc.cluster.local
          port: 19530
          database: semantic_router_cache
          timeout: 30
          auth:
            enabled: true
            username: root
            password_secret_ref:
              name: milvus-credentials
              key: password
          tls:
            enabled: false

        collection:
          name: semantic_cache
          description: "Semantic cache for LLM responses"
          vector_field:
            name: embedding
            dimension: 384  # For BERT embeddings
            metric_type: IP
          index:
            type: HNSW
            params:
              M: 16
              efConstruction: 64

        search:
          params:
            ef: 64
          topk: 10
          consistency_level: Session

        performance:
          connection_pool:
            max_connections: 10
            max_idle_connections: 5
            acquire_timeout: 30
          batch:
            insert_batch_size: 100
            timeout: 60

        data_management:
          ttl:
            enabled: true
            timestamp_field: created_at
            cleanup_interval: 3600
          compaction:
            enabled: false
            interval: 86400

        development:
          drop_collection_on_startup: false
          auto_create_collection: true
          verbose_errors: true

    # Disable features that require additional models for this example
    # Enable these features in production with proper model configuration
    prompt_guard:
      enabled: false

    tools:
      enabled: false

---
# Secret for Milvus password (create separately)
# In production, use a secret management system like External Secrets Operator
apiVersion: v1
kind: Secret
metadata:
  name: milvus-credentials
  namespace: default
type: Opaque
stringData:
  password: "your-milvus-password-here"
