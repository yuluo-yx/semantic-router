name: Publish Helm Chart

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
    paths:
      - "deploy/helm/**"
  push:
    branches:
      - main
    paths:
      - "deploy/helm/**"
  workflow_dispatch:

env:
  HELM_VERSION: v3.14.0
  CHART_PATH: deploy/helm/semantic-router
  REGISTRY: ghcr.io
  CHART_NAME: semantic-router

jobs:
  validate-and-package:
    name: Validate and Package
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      chart-name: ${{ steps.package.outputs.name }}
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint chart
        run: helm lint ${{ env.CHART_PATH }}

      - name: Package chart
        id: package
        run: |
          helm package -u ${{ env.CHART_PATH }} --version v0.0.0-latest --destination .
          echo "name=$(ls *.tgz)" >> $GITHUB_OUTPUT

      - name: Upload packaged chart
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: "*.tgz"
          retention-days: 1

  publish-chart:
    name: Publish to GHCR
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    needs: validate-and-package
    permissions:
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: helm-chart

      - uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Publish chart
        run: |
          CHART="${{ needs.validate-and-package.outputs.chart-name }}"
          REPO="${{ env.REGISTRY }}/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/charts"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          helm push "$CHART" "oci://$REPO"
          helm registry logout ${{ env.REGISTRY }}

      - name: Create release summary
        run: |
          REPOSITORY_OWNER_LOWER="$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“¦ Helm Chart Published

          **Chart:** \`${{ env.CHART_NAME }}\`
          **Version:** \`v0.0.0-latest\`
          **Registry:** \`${{ env.REGISTRY }}/$REPOSITORY_OWNER_LOWER/charts\`

          ### Installation

          \`\`\`bash
          # Pull the chart
          helm pull oci://${{ env.REGISTRY }}/$REPOSITORY_OWNER_LOWER/charts/${{ env.CHART_NAME }} --version v0.0.0-latest

          # Install directly
          helm install semantic-router oci://${{ env.REGISTRY }}/$REPOSITORY_OWNER_LOWER/charts/${{ env.CHART_NAME }} \\
            --version v0.0.0-latest \\
            --namespace vllm-semantic-router-system \\
            --create-namespace
          \`\`\`

          ### Upgrade

          \`\`\`bash
          helm upgrade semantic-router oci://${{ env.REGISTRY }}/$REPOSITORY_OWNER_LOWER/charts/${{ env.CHART_NAME }} \\
            --version v0.0.0-latest \\
            --namespace vllm-semantic-router-system
          \`\`\`
          EOF
