name: Owner Notification

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-owners:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*

      - name: Find owners and notify
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get changed files
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');
            console.log('Changed files:', changedFiles);
            
            // Function to find OWNER file for a given file path
            function findOwnerFile(filePath) {
              const parts = filePath.split('/');
              
              // Check root directory first
              if (fs.existsSync('OWNER')) {
                const content = fs.readFileSync('OWNER', 'utf8');
                const owners = content.split('\n')
                  .filter(line => line.trim().startsWith('@'))
                  .map(line => line.trim());
                if (owners.length > 0) {
                  return { path: '.', owners };
                }
              }
              
              // Check first level directory
              if (parts.length > 1) {
                const firstLevelDir = parts[0];
                const ownerPath = path.join(firstLevelDir, 'OWNER');
                if (fs.existsSync(ownerPath)) {
                  const content = fs.readFileSync(ownerPath, 'utf8');
                  const owners = content.split('\n')
                    .filter(line => line.trim().startsWith('@'))
                    .map(line => line.trim());
                  if (owners.length > 0) {
                    return { path: firstLevelDir, owners };
                  }
                }
              }
              
              return null;
            }
            
            // Collect all owners for changed files
            const ownerMap = new Map();
            
            for (const file of changedFiles) {
              if (!file.trim()) continue;
              
              const ownerInfo = findOwnerFile(file);
              if (ownerInfo) {
                if (!ownerMap.has(ownerInfo.path)) {
                  ownerMap.set(ownerInfo.path, {
                    owners: ownerInfo.owners,
                    files: []
                  });
                }
                ownerMap.get(ownerInfo.path).files.push(file);
              }
            }
            
            if (ownerMap.size === 0) {
              console.log('No owners found for changed files');
              return;
            }
            
            // Create comment content
            let commentBody = '## ðŸ‘¥ Owner Notification\n\n';
            commentBody += 'The following owners have been identified for the changed files in this PR:\n\n';
            
            for (const [dirPath, info] of ownerMap) {
              commentBody += `### ðŸ“ \`${dirPath === '.' ? 'Root Directory' : dirPath}\`\n`;
              commentBody += `**Owners:** ${info.owners.join(', ')}\n`;
              commentBody += `**Files changed:**\n`;
              for (const file of info.files) {
                commentBody += `- \`${file}\`\n`;
              }
              commentBody += '\n';
            }
            
            commentBody += '---\n';
            commentBody += '*This comment was automatically generated based on the OWNER files in the repository.*';
            
            // Get existing comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Check if we already have an owner notification comment
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('## ðŸ‘¥ Owner Notification')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('Updated existing owner notification comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new owner notification comment');
            }
