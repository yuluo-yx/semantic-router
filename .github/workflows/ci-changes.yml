name: CI Changes
on:
  workflow_call:
    outputs:
      core:
        value: ${{ jobs.filter.outputs.core }}
      dashboard:
        value: ${{ jobs.filter.outputs.dashboard }}
      website:
        value: ${{ jobs.filter.outputs.website }}
      docs:
        value: ${{ jobs.filter.outputs.docs }}
      helm:
        value: ${{ jobs.filter.outputs.helm }}
      e2e:
        value: ${{ jobs.filter.outputs.e2e }}
      ci:
        value: ${{ jobs.filter.outputs.ci }}
      docker:
        value: ${{ jobs.filter.outputs.docker }}
      make:
        value: ${{ jobs.filter.outputs.make }}
      # Per-profile e2e change detection
      e2e_istio:
        value: ${{ jobs.filter.outputs.e2e_istio }}
      e2e_ai_gateway:
        value: ${{ jobs.filter.outputs.e2e_ai_gateway }}
      e2e_aibrix:
        value: ${{ jobs.filter.outputs.e2e_aibrix }}
      e2e_dynamic_config:
        value: ${{ jobs.filter.outputs.e2e_dynamic_config }}
      e2e_llm_d:
        value: ${{ jobs.filter.outputs.e2e_llm_d }}
      e2e_routing_strategies:
        value: ${{ jobs.filter.outputs.e2e_routing_strategies }}
      e2e_production_stack:
        value: ${{ jobs.filter.outputs.e2e_production_stack }}
      e2e_response_api:
        value: ${{ jobs.filter.outputs.e2e_response_api }}
      e2e_common:
        value: ${{ jobs.filter.outputs.e2e_common }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.changes.outputs.core }}
      dashboard: ${{ steps.changes.outputs.dashboard }}
      website: ${{ steps.changes.outputs.website }}
      docs: ${{ steps.changes.outputs.docs }}
      helm: ${{ steps.changes.outputs.helm }}
      e2e: ${{ steps.changes.outputs.e2e }}
      ci: ${{ steps.changes.outputs.ci }}
      docker: ${{ steps.changes.outputs.docker }}
      make: ${{ steps.changes.outputs.make }}
      # Per-profile e2e outputs
      e2e_istio: ${{ steps.changes.outputs.e2e_istio }}
      e2e_ai_gateway: ${{ steps.changes.outputs.e2e_ai_gateway }}
      e2e_aibrix: ${{ steps.changes.outputs.e2e_aibrix }}
      e2e_dynamic_config: ${{ steps.changes.outputs.e2e_dynamic_config }}
      e2e_llm_d: ${{ steps.changes.outputs.e2e_llm_d }}
      e2e_routing_strategies: ${{ steps.changes.outputs.e2e_routing_strategies }}
      e2e_production_stack: ${{ steps.changes.outputs.e2e_production_stack }}
      e2e_response_api: ${{ steps.changes.outputs.e2e_response_api }}
      e2e_common: ${{ steps.changes.outputs.e2e_common }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: changes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            core:
              - 'src/**'
              - 'candle-binding/**'
              - 'bench/**'
              - 'config/**'
              - 'scripts/**'
              - 'deploy/examples/**'
              - 'tools/**'
              - 'go.mod'
              - 'go.sum'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'pyproject.toml'
              - 'e2e/testing/llm-katan/**'
            dashboard:
              - 'dashboard/**'
            website:
              - 'website/**'
            docs:
              - 'docs/**'
              - '**/*.md'
              - '**/*.mdx'
            helm:
              - 'deploy/helm/**'
            e2e:
              - 'e2e/testing/**'
              - 'e2e/**'
              - 'scripts/quickstart.sh'
              - 'deploy/docker-compose/**'
              - 'deploy/kubernetes/**'
              - 'deploy/kserve/**'
              - 'deploy/openshift/**'
            ci:
              - '.github/workflows/**'
            docker:
              - 'tools/docker/Dockerfile*'
              - 'docker/**'
              - 'docker-compose*'
              - 'deploy/docker-compose/**'
            make:
              - 'Makefile'
              - 'tools/make/**'
            # Per-profile e2e filters
            e2e_istio:
              - 'e2e/profiles/istio/**'
              - 'deploy/kubernetes/istio/**'
            e2e_ai_gateway:
              - 'e2e/profiles/ai-gateway/**'
              - 'deploy/kubernetes/ai-gateway/**'
            e2e_aibrix:
              - 'e2e/profiles/aibrix/**'
              - 'deploy/kubernetes/aibrix/**'
            e2e_dynamic_config:
              - 'e2e/profiles/dynamic-config/**'
            e2e_llm_d:
              - 'e2e/profiles/llm-d/**'
              - 'deploy/kubernetes/llmd-base/**'
            e2e_routing_strategies:
              - 'e2e/profiles/routing-strategies/**'
              - 'deploy/kubernetes/routing-strategies/**'
            e2e_production_stack:
              - 'e2e/profiles/production-stack/**'
            e2e_response_api:
              - 'e2e/profiles/response-api/**'
            # Common e2e code that affects all profiles
            e2e_common:
              - 'e2e/pkg/**'
              - 'e2e/cmd/**'
              - 'e2e/testcases/**'
              - 'e2e/*.go'
              - 'e2e/go.mod'
              - 'e2e/go.sum'
