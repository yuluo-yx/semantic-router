name: Publish Python Package to PyPI

on:
  push:
    branches:
      - main  # Triggers on every push to main branch
    tags:
      - 'v*'  # Also triggers on version tags like v0.1.0, v0.2.0, etc.
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    if: github.repository == 'vllm-project/semantic-router'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing to PyPI

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract version from tag, input, or pyproject.toml
        id: extract_version
        working-directory: src/vllm-sr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ inputs.version }}" ]; then
              VERSION="${{ inputs.version }}"
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "tag=v$VERSION" >> $GITHUB_OUTPUT
              echo "is_dev=false" >> $GITHUB_OUTPUT
            else
              echo "::error::Version input is required for manual dispatch"
              exit 1
            fi
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract from tag - this is a release version
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "is_dev=false" >> $GITHUB_OUTPUT
          else
            # Push to main - generate development version
            BASE_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
            TIMESTAMP=$(date -u +%Y%m%d%H%M%S)

            # Generate dev version: 0.1.0.dev20240115123456
            # Note: PyPI doesn't allow local version identifiers (+git.xxx)
            DEV_VERSION="${BASE_VERSION}.dev${TIMESTAMP}"

            echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$DEV_VERSION" >> $GITHUB_OUTPUT
            echo "is_dev=true" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT

            echo "Publishing development version: $DEV_VERSION (commit: ${{ github.sha }})"
          fi

      - name: Verify package version matches tag
        if: github.event_name != 'workflow_dispatch' && startsWith(github.ref, 'refs/tags/')
        working-directory: src/vllm-sr
        run: |
          PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.extract_version.outputs.version }}"
          echo "Package version: $PACKAGE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Package version ($PACKAGE_VERSION) does not match tag version ($TAG_VERSION)"
            echo "::error::Please update version in src/vllm-sr/pyproject.toml to $TAG_VERSION"
            exit 1
          fi

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version in pyproject.toml for dev builds
        if: steps.extract_version.outputs.is_dev == 'true'
        working-directory: src/vllm-sr
        run: |
          echo "Updating version to ${{ steps.extract_version.outputs.version }}"
          sed -i.bak 's/^version = .*/version = "${{ steps.extract_version.outputs.version }}"/' pyproject.toml
          echo "Updated pyproject.toml:"
          grep '^version = ' pyproject.toml

      - name: Build package
        working-directory: src/vllm-sr
        run: |
          echo "Building vllm-sr package..."
          python -m build
          echo "Package built successfully!"
          ls -la dist/

      - name: Verify package contents
        working-directory: src/vllm-sr
        run: |
          echo "Verifying package contents..."
          echo ""
          echo "=== Wheel contents ==="
          unzip -l dist/*.whl | grep -E "(cli/templates|\.yaml|\.json|\.ini)" || echo "WARNING: No template files found!"
          echo ""
          echo "=== Checking required template files ==="
          REQUIRED_FILES=(
            "cli/templates/config.template.yaml"
            "cli/templates/envoy.template.yaml"
            "cli/templates/router-defaults.yaml"
            "cli/templates/tools_db.json"
            "cli/templates/grafana.serve.ini"
            "cli/templates/grafana-datasource.serve.yaml"
            "cli/templates/grafana-datasource-jaeger.serve.yaml"
            "cli/templates/grafana-dashboard.serve.yaml"
            "cli/templates/llm-router-dashboard.serve.json"
            "cli/templates/prometheus.serve.yaml"
          )
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if unzip -l dist/*.whl | grep -q "$file"; then
              echo "âœ“ Found: $file"
            else
              echo "âœ— Missing: $file"
              MISSING_FILES+=("$file")
            fi
          done
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo ""
            echo "ERROR: Missing required template files in package!"
            echo "Please check pyproject.toml and MANIFEST.in configuration."
            exit 1
          fi
          echo ""
          echo "âœ“ All required template files are present in the package"

      - name: Check package with twine
        working-directory: src/vllm-sr
        run: |
          twine check dist/*

      - name: Publish to Test PyPI (dry run)
        if: github.event_name == 'workflow_dispatch'
        working-directory: src/vllm-sr
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          echo "Publishing to Test PyPI..."
          twine upload --repository testpypi dist/* --verbose || true
          echo ""
          echo "Test installation command:"
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ vllm-sr==${{ steps.extract_version.outputs.version }}"

      - name: Publish to PyPI
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
        working-directory: src/vllm-sr
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Publishing to PyPI..."
          twine upload dist/* --verbose

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.tag }}
          name: vllm-sr ${{ steps.extract_version.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            ```bash
            pip install vllm-sr==${{ steps.extract_version.outputs.version }}
            ```

            ## What's Changed
            See the full changelog below.
          files: |
            src/vllm-sr/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Package Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.extract_version.outputs.is_dev }}" = "true" ]; then
            echo "**Type:** Development Release ðŸš§" >> $GITHUB_STEP_SUMMARY
            echo "**Base Version:** ${{ steps.extract_version.outputs.base_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** [\`${{ steps.extract_version.outputs.commit_sha }}\`](https://github.com/${{ github.repository }}/commit/${{ steps.extract_version.outputs.commit_sha }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Type:** Stable Release âœ…" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.extract_version.outputs.is_dev }}" = "true" ]; then
            echo "# Install this specific development version:" >> $GITHUB_STEP_SUMMARY
            echo "pip install vllm-sr==${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Or install the latest development version:" >> $GITHUB_STEP_SUMMARY
            echo "pip install --pre vllm-sr" >> $GITHUB_STEP_SUMMARY
          else
            echo "pip install vllm-sr==${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI Package](https://pypi.org/project/vllm-sr/${{ steps.extract_version.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.extract_version.outputs.is_dev }}" = "false" ]; then
            echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.extract_version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          fi

