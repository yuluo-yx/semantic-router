name: Integration Test [Docker Compose]

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
    paths-ignore:
      - "website/**"
      - "**/*.md"
  push:
    branches:
      - main
    paths-ignore:
      - "website/**"
      - "**/*.md"
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-ci-compose:
    if: github.repository == 'vllm-project/semantic-router' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    timeout-minutes: 20 # Reduced from 30 - CI compose is faster

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Setup model storage on /mnt
        run: |
          # Use /mnt for model storage (has ~75GB vs ~14GB on root)
          # This helps prevent "no space left on device" errors
          echo "Disk space before setup:"
          df -h / && df -h /mnt

          # Create /mnt/models directory if it doesn't exist
          sudo mkdir -p /mnt/models
          sudo chown -R $USER:$USER /mnt/models

          # If models directory already exists in workspace, move it to /mnt
          if [ -d "models" ] && [ ! -L "models" ]; then
            echo "Moving existing models directory to /mnt/models..."
            # Move contents if /mnt/models is not empty, otherwise just move the directory
            if [ "$(ls -A /mnt/models 2>/dev/null)" ]; then
              echo "Warning: /mnt/models already has content, merging..."
              sudo cp -r models/* /mnt/models/ || true
              rm -rf models
            else
              sudo mv models /mnt/models
            fi
          fi

          # Create symlink from models/ to /mnt/models/ so existing code continues to work
          if [ ! -e "models" ]; then
            ln -s /mnt/models models
            echo "Created symlink: models -> /mnt/models"
          elif [ -L "models" ]; then
            echo "Symlink already exists: models -> $(readlink models)"
          else
            echo "Warning: models exists but is not a symlink"
          fi

          echo "Disk space after setup:"
          df -h / && df -h /mnt
          echo "Models directory setup complete. Models will be stored in /mnt/models"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make curl
          pip install -r src/model_manager/requirements.txt

      - name: Download models
        run: |
          echo "Downloading minimal models for CI..."
          make download-models
        env:
          CI: true
          CI_MINIMAL_MODELS: true
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_HUB_ENABLE_HF_TRANSFER: 1
          HF_HUB_DISABLE_TELEMETRY: 1

      - name: Start CI services
        run: |
          echo "Starting minimal CI services (semantic-router, envoy, llm-katan)..."
          make docker-compose-up-ci
        env:
          CI: true

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          max_attempts=60
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking service health..."
            
            # Check semantic-router health
            if docker ps --filter "name=semantic-router" --filter "health=healthy" --format "{{.Names}}" | grep -q "semantic-router"; then
              echo "âœ… semantic-router is healthy"
              
              # Check envoy health
              if docker ps --filter "name=envoy-proxy" --filter "health=healthy" --format "{{.Names}}" | grep -q "envoy-proxy"; then
                echo "âœ… envoy-proxy is healthy"
                
                # Check llm-katan health
                if docker ps --filter "name=llm-katan" --filter "health=healthy" --format "{{.Names}}" | grep -q "llm-katan"; then
                  echo "âœ… llm-katan is healthy"
                  echo "ðŸŽ‰ All services are healthy!"
                  exit 0
                fi
              fi
            fi
            
            # Show current status
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "NAMES|semantic-router|envoy|llm-katan" || true
            
            sleep 5
            ((attempt++))
          done

          echo "âŒ Timeout waiting for services to be healthy"
          docker ps -a
          exit 1

      - name: Test semantic router health endpoint
        run: |
          echo "Testing semantic router health..."
          curl -f http://localhost:8080/health || {
            echo "âŒ Health check failed"
            exit 1
          }
          echo "âœ… Health check passed"

      - name: Test envoy proxy endpoint
        run: |
          echo "Testing envoy proxy..."
          curl -f http://localhost:19000/ready || {
            echo "âŒ Envoy ready check failed"
            exit 1
          }
          echo "âœ… Envoy is ready"

      - name: Test llm-katan endpoint
        run: |
          echo "Testing llm-katan..."
          curl -f http://localhost:8002/health || {
            echo "âŒ LLM-Katan health check failed"
            exit 1
          }
          echo "âœ… LLM-Katan is healthy"

      - name: Test semantic routing functionality
        run: |
          echo "Testing semantic router with a sample query..."

          response=$(curl -s -X POST http://localhost:8801/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{
              "model": "qwen3",
              "messages": [{"role": "user", "content": "What is 2 + 2?"}],
              "temperature": 0.7
            }')

          echo "Response: $response"

          # Verify we got a response
          if echo "$response" | grep -q "choices"; then
            echo "âœ… Chat completions test passed"
          else
            echo "âš ï¸ Response may not contain expected fields, but request succeeded"
          fi

      - name: Test Response API - Create Response
        run: |
          echo "Testing Response API: POST /v1/responses..."

          response=$(curl -s -X POST http://localhost:8801/v1/responses \
            -H "Content-Type: application/json" \
            -d '{
              "model": "qwen3",
              "input": "What is 2 + 2?",
              "store": true
            }')

          echo "Response: $response"

          # Extract response ID for subsequent tests
          response_id=$(echo "$response" | jq -r '.id // empty')
          if [ -n "$response_id" ] && [[ "$response_id" == resp_* ]]; then
            echo "âœ… Response API create test passed (id=$response_id)"
            echo "RESPONSE_ID=$response_id" >> $GITHUB_ENV
          else
            echo "âŒ Response API create test failed - invalid or missing response ID"
            exit 1
          fi

      - name: Test Response API - Get Response
        run: |
          echo "Testing Response API: GET /v1/responses/$RESPONSE_ID..."

          response=$(curl -s -X GET "http://localhost:8801/v1/responses/$RESPONSE_ID" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          # Verify response ID matches
          got_id=$(echo "$response" | jq -r '.id // empty')
          if [ "$got_id" = "$RESPONSE_ID" ]; then
            echo "âœ… Response API get test passed"
          else
            echo "âŒ Response API get test failed - ID mismatch (expected=$RESPONSE_ID, got=$got_id)"
            exit 1
          fi

      - name: Test Response API - Get Input Items
        run: |
          echo "Testing Response API: GET /v1/responses/$RESPONSE_ID/input_items..."

          response=$(curl -s -X GET "http://localhost:8801/v1/responses/$RESPONSE_ID/input_items" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          # Verify it's a list
          object_type=$(echo "$response" | jq -r '.object // empty')
          if [ "$object_type" = "list" ]; then
            echo "âœ… Response API input_items test passed"
          else
            echo "âŒ Response API input_items test failed - expected object=list, got=$object_type"
            exit 1
          fi

      - name: Test Response API - Delete Response
        run: |
          echo "Testing Response API: DELETE /v1/responses/$RESPONSE_ID..."

          response=$(curl -s -X DELETE "http://localhost:8801/v1/responses/$RESPONSE_ID" \
            -H "Content-Type: application/json")

          echo "Response: $response"

          # Verify deletion
          deleted=$(echo "$response" | jq -r '.deleted // empty')
          if [ "$deleted" = "true" ]; then
            echo "âœ… Response API delete test passed"
          else
            echo "âŒ Response API delete test failed - expected deleted=true"
            exit 1
          fi

          # Verify 404 on subsequent get
          get_response=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8801/v1/responses/$RESPONSE_ID")
          if [ "$get_response" = "404" ]; then
            echo "âœ… Response API delete verification passed (404 on get)"
          else
            echo "âŒ Response API delete verification failed - expected 404, got $get_response"
            exit 1
          fi

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          make docker-compose-logs-ci || docker compose -f deploy/docker-compose/docker-compose.ci.yml logs
          echo "=== Container Status ==="
          docker ps -a
          echo "=== Semantic Router Logs ==="
          docker logs semantic-router 2>&1 | tail -100 || true
          echo "=== Envoy Logs ==="
          docker logs envoy-proxy 2>&1 | tail -100 || true
          echo "=== LLM-Katan Logs ==="
          docker logs llm-katan 2>&1 | tail -100 || true

      - name: Clean up
        if: always()
        run: |
          make docker-compose-down-ci || true
          docker system prune -af --volumes || true
