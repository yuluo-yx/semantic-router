# You can override by specifying your own mappings below:
# Uncomment and customize if you need different model mappings:
# mom_registry:
#   "models/mom-domain-classifier": "LLM-Semantic-Router/lora_intent_classifier_bert-base-uncased_model"
#   "models/mom-pii-classifier": "LLM-Semantic-Router/lora_pii_detector_bert-base-uncased_model"
#   "models/mom-jailbreak-classifier": "LLM-Semantic-Router/lora_jailbreak_classifier_bert-base-uncased_model"
#   "models/mom-halugate-detector": "KRLabsOrg/lettucedect-base-modernbert-en-v1"
#   "models/mom-halugate-sentinel": "LLM-Semantic-Router/halugate-sentinel"
#   "models/mom-halugate-explainer": "tasksource/ModernBERT-base-nli"
#   "models/mom-feedback-detector": "llm-semantic-router/feedback-detector"
#   "models/mom-embedding-pro": "Qwen/Qwen3-Embedding-0.6B"
#   "models/mom-embedding-flash": "google/embeddinggemma-300m"

# Response API Configuration
# Enables OpenAI Response API support with conversation chaining
response_api:
  enabled: true
  store_backend: "memory"  # Options: "memory", "milvus", "redis"
  ttl_seconds: 86400       # 24 hours
  max_responses: 1000

semantic_cache:
  enabled: true
  backend_type: "memory"  # Options: "memory", "milvus", or "hybrid"
  similarity_threshold: 0.8
  max_entries: 1000  # Only applies to memory backend
  ttl_seconds: 3600
  eviction_policy: "fifo"
  # HNSW index configuration (for memory backend only)
  use_hnsw: true  # Enable HNSW index for faster similarity search
  hnsw_m: 16  # Number of bi-directional links (higher = better recall, more memory)
  hnsw_ef_construction: 200  # Construction parameter (higher = better quality, slower build)

  # Hybrid cache configuration (when backend_type: "hybrid")
  # Combines in-memory HNSW for fast search with Milvus for scalable storage
  # max_memory_entries: 100000 # Max entries in HNSW index (default: 100,000)
  # backend_config_path: "config/milvus.yaml" # Path to Milvus config

  # Embedding model for semantic similarity matching
  # Options: "bert" (fast, 384-dim), "qwen3" (high quality, 1024-dim, 32K context), "gemma" (balanced, 768-dim, 8K context)
  # Default: "bert" (fastest, lowest memory)
  embedding_model: "bert"

bert_model:
  model_id: models/mom-embedding-light
  threshold: 0.6
  use_cpu: true

tools:
  enabled: true
  top_k: 3
  similarity_threshold: 0.2
  tools_db_path: "config/tools_db.json"
  fallback_to_empty: true

prompt_guard:
  enabled: true  # Global default - can be overridden per category with jailbreak_enabled
  use_modernbert: false
  model_id: "models/mom-jailbreak-classifier"
  jailbreak_mapping_path: "models/mom-jailbreak-classifier/jailbreak_type_mapping.json"
  threshold: 0.7
  use_cpu: true

# Classifier configuration
classifier:
  category_model:
    model_id: "models/mom-domain-classifier"
    threshold: 0.6
    use_cpu: true
    category_mapping_path: "models/mom-domain-classifier/category_mapping.json"
  pii_model:
    model_id: "models/mom-pii-classifier"
    use_modernbert: false
    threshold: 0.9
    use_cpu: true
    pii_mapping_path: "models/mom-pii-classifier/pii_type_mapping.json"

# Hallucination mitigation configuration
# Disabled by default - enable in decisions via hallucination plugin
hallucination_mitigation:
  enabled: false
  # Fact-check classifier: determines if a prompt needs fact verification
  fact_check_model:
    model_id: "models/mom-halugate-sentinel"
    threshold: 0.6
    use_cpu: true
  # Hallucination detector: verifies if LLM response is grounded in context
  hallucination_model:
    model_id: "models/mom-halugate-detector"
    threshold: 0.8
    use_cpu: true
    # False positive reduction settings
    min_span_length: 2  # Minimum tokens in a span to report (filters single-token false positives)
    min_span_confidence: 0.6  # Minimum confidence for a span to be reported
    context_window_size: 50  # Characters of context around flagged spans
    enable_nli_filtering: true  # Use NLI to filter false positives
    nli_entailment_threshold: 0.75  # Filter spans with high entailment scores
  # NLI model: provides explanations for hallucinated spans
  nli_model:
    model_id: "models/mom-halugate-explainer"
    threshold: 0.9
    use_cpu: true

# Feedback detector configuration
# Classifies user feedback into 4 types: satisfied, need_clarification, wrong_answer, want_different
feedback_detector:
  enabled: true
  model_id: "models/mom-feedback-detector"
  threshold: 0.7
  use_cpu: true

# External models configuration
# Used for advanced routing signals like preference-based routing via external LLM
# Users can configure external models in their config to enable these features
# Example:
# external_models:
#   - llm_provider: "vllm"
#     model_role: "preference"
#     llm_endpoint:
#       address: "127.0.0.1"
#       port: 8000
#     llm_model_name: "openai/gpt-oss-120b"
#     llm_timeout_seconds: 30
#     parser_type: "json"
#     access_key: ""  # Optional: for Authorization header (Bearer token)

# Embedding Models Configuration
# These models provide intelligent embedding generation with automatic routing:
# - Qwen3-Embedding-0.6B: Up to 32K context, high quality,
# - EmbeddingGemma-300M: Up to 8K context, fast inference, Matryoshka support (768/512/256/128)
embedding_models:
  qwen3_model_path: "models/mom-embedding-pro"
  # gemma_model_path: "models/mom-embedding-flash"
  use_cpu: true  # Set to false for GPU acceleration (requires CUDA)
  # HNSW Configuration
  # Improves performance by preloading candidate embeddings at startup
  # and using HNSW index for O(log n) similarity search
  hnsw_config:
    model_type: "qwen3"         # Which model to use: "qwen3" (high quality) or "gemma" (fast)
    preload_embeddings: true    # Precompute candidate embeddings at startup
    target_dimension: 1024       # Embedding dimension
    enable_soft_matching: true
    min_score_threshold: 0.5

# Observability Configuration
observability:
  metrics:
    enabled: true  # Enable Prometheus /metrics endpoint for vllm-sr serve
  tracing:
    enabled: true  # Enable distributed tracing for vllm-sr serve
    provider: "opentelemetry"  # Provider: opentelemetry, openinference, openllmetry
    exporter:
      type: "otlp"  # Export spans to Jaeger (via OTLP gRPC)
      endpoint: "vllm-sr-jaeger:4317"  # Jaeger collector (use container name for vllm-sr serve)
      insecure: true  # Use insecure connection (no TLS)
    sampling:
      type: "always_on"  # Sampling: always_on, always_off, probabilistic
      rate: 1.0  # Sampling rate for probabilistic (0.0-1.0)
    resource:
      service_name: "vllm-sr"
      service_version: "v0.1.0"
      deployment_environment: "development"

# Looper Configuration
# The looper handles multi-model orchestration for decisions with multiple model_refs
# It makes HTTP calls through Envoy to execute algorithms like confidence routing
# NOTE: Looper requests include "x-vsr-looper-request: true" header, so ExtProc skips
#       plugin processing to avoid infinite loops
looper:
  enabled: true  # Enable looper for multi-model decisions
  # Endpoint points to Envoy (same container), which handles load balancing and auth
  # Port should match listener port (default: 8888)
  endpoint: "http://localhost:8888/v1/chat/completions"
  timeout_seconds: 120  # Timeout in seconds for each model call
  headers: {}  # Optional headers (e.g., {"Authorization": "Bearer xxx"})

clear_route_cache: true
