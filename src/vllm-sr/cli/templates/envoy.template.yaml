admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
  {% for listener in listeners %}
  - name: {{ listener.name }}
    address:
      socket_address:
        address: {{ listener.address }}
        port_value: {{ listener.port }}
    perConnectionBufferLimitBytes: 52428800
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              routes:
              {% for model in models %}
              # Route for model: {{ model.name }}
              - match:
                  prefix: "/"
                  headers:
                  - name: x-selected-model
                    string_match:
                      exact: "{{ model.name }}"
                route:
                  cluster: {{ model.cluster_name }}_cluster
                  timeout: {{ listener.timeout | default('300s') }}
                  idleTimeout: 300s
                  # Rewrite Host header to match upstream server
                  host_rewrite_literal: "{{ model.endpoints[0].address }}"
                  {% if model.path_prefix %}
                  # Prepend path prefix to all requests (e.g., /compatible-mode + /v1/chat/completions = /compatible-mode/v1/chat/completions)
                  regex_rewrite:
                    pattern:
                      google_re2: {}
                      regex: "^(.*)$"
                    substitution: "{{ model.path_prefix }}\\1"
                  {% endif %}
              {% endfor %}
              {% for model in anthropic_models %}
              # Route for Anthropic model: {{ model.name }}
              - match:
                  prefix: "/"
                  headers:
                  - name: x-selected-model
                    string_match:
                      exact: "{{ model.name }}"
                route:
                  cluster: anthropic_api_cluster
                  timeout: {{ listener.timeout | default('300s') }}
                  idleTimeout: 300s
                  host_rewrite_literal: "api.anthropic.com"
              {% endfor %}
              # Default route (no x-selected-model header)
              - match:
                  prefix: "/"
                route:
                  {% if models %}
                  # Route to first model by default
                  cluster: {{ models[0].cluster_name }}_cluster
                  {% else %}
                  cluster: vllm_static_cluster
                  {% endif %}
                  timeout: {{ listener.timeout | default('300s') }}
                  {% if models %}
                  # Rewrite Host header to match upstream server
                  host_rewrite_literal: "{{ models[0].endpoints[0].address }}"
                  {% endif %}
                  {% if models and models[0].path_prefix %}
                  # Prepend path prefix to all requests (e.g., /compatible-mode + /v1/chat/completions = /compatible-mode/v1/chat/completions)
                  regex_rewrite:
                    pattern:
                      google_re2: {}
                      regex: "^(.*)$"
                    substitution: "{{ models[0].path_prefix }}\\1"
                  {% endif %}
          http_filters:
          - name: envoy.filters.http.ext_proc
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
              allow_mode_override: true
              grpc_service:
                envoy_grpc:
                  cluster_name: extproc_service
                timeout: 300s
              processing_mode:
                request_header_mode: "SEND"
                response_header_mode: "SEND"
                request_body_mode: "BUFFERED"
                response_body_mode: "BUFFERED"
              message_timeout: {{ listener.timeout | default('300s') }}
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: /var/log/envoy_access.log
              format: "[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\"\n"
  {% endfor %}

  clusters:
  # ExtProc service (semantic router)
  - name: extproc_service
    connect_timeout: 300s
    type: STATIC
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: extproc_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: {{ extproc_port }}

  {% if not models %}
  # Fallback cluster for API-only configs (not actually used, but required for valid Envoy config)
  # When all models are API-based, the router handles requests directly without routing through Envoy clusters
  - name: vllm_static_cluster
    connect_timeout: 30s
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: vllm_static_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
  {% endif %}

  {% for model in models %}
  # Cluster for model: {{ model.name }}
  - name: {{ model.cluster_name }}_cluster
    connect_timeout: 300s
    type: {{ model.cluster_type }}
    {% if model.cluster_type == 'LOGICAL_DNS' %}
    dns_lookup_family: V4_ONLY
    {% endif %}
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: {{ model.cluster_name }}_cluster
      endpoints:
      - lb_endpoints:
        {% for endpoint in model.endpoints %}
        - endpoint:
            address:
              socket_address:
                address: {{ endpoint.address }}
                port_value: {{ endpoint.port }}
            {% if endpoint.is_domain %}
            hostname: "{{ endpoint.address }}"
            {% endif %}
          load_balancing_weight: {{ endpoint.weight | default(1) }}
        {% endfor %}
    {% if model.has_https %}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: {{ model.endpoints[0].address }}
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            tls_maximum_protocol_version: TLSv1_3
    {% endif %}
  {% endfor %}

  {% if anthropic_models %}
  # Shared cluster for Anthropic API (all Anthropic models use this cluster)
  - name: anthropic_api_cluster
    type: LOGICAL_DNS
    dns_lookup_family: V4_ONLY
    connect_timeout: 60s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: anthropic_api_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: api.anthropic.com
                port_value: 443
            hostname: "api.anthropic.com"
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        sni: api.anthropic.com
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            tls_maximum_protocol_version: TLSv1_3
  {% endif %}

# Runtime configuration
layered_runtime:
  layers:
  - name: static_layer
    static_layer:
      overload:
        global_downstream_max_connections: 50000
