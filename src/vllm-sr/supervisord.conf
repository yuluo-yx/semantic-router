[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
; To prevent "Too many open files" errors.
minfds=65536
minprocs=200

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:router]
command=/app/start-router.sh /app/config.yaml /app/.vllm-sr
stdout_logfile=/var/log/supervisor/router.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/router-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
redirect_stderr=false
autorestart=true
priority=1
environment=LD_LIBRARY_PATH="/usr/local/lib"

[program:envoy]
command=/bin/sh -c "python -m cli.config_generator /app/config.yaml /etc/envoy/envoy.yaml && /usr/local/bin/envoy -c /etc/envoy/envoy.yaml --log-level debug --log-format '[%%Y-%%m-%%d %%T.%%e][%%l] %%v'"
stdout_logfile=/var/log/supervisor/envoy.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/envoy-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
redirect_stderr=false
autorestart=true
priority=2
startsecs=5

[program:tail_access_logs]
command=/bin/sh -c "touch /var/log/envoy_access.log && tail -F /var/log/envoy_access.log 2>/dev/null || sleep infinity"
stdout_logfile=/var/log/supervisor/tail_access_logs.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/tail_access_logs-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
redirect_stderr=false
autorestart=true
priority=3

[program:dashboard]
command=/app/start-dashboard.sh /app/config.yaml
stdout_logfile=/var/log/supervisor/dashboard.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/dashboard-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
redirect_stderr=false
autorestart=true
priority=4
startsecs=3

[program:log_forwarder]
command=/bin/sh -c "tail -F /var/log/supervisor/router.log /var/log/supervisor/router-error.log /var/log/supervisor/envoy.log /var/log/supervisor/envoy-error.log /var/log/supervisor/dashboard.log /var/log/supervisor/dashboard-error.log 2>/dev/null || sleep infinity"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
redirect_stderr=false
autorestart=true
priority=5
startsecs=1

