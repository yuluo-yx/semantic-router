# ============================================================================
# vLLM Semantic Router Stack Docker Image
# ============================================================================
# Complete single-container deployment with all components:
# - semantic-router (Rust library + Go service)
# - dashboard (Go backend + React frontend)
# - Envoy proxy (API gateway)
# - Prometheus (metrics collection)
# - Grafana (monitoring dashboards)
# - Jaeger (distributed tracing)
# - MongoDB (database)
# - chat-ui (web UI)
# - open-webui (web UI)
# - pipelines (web UI)
# - LLM-katan (LLM)
#
# Supports: linux/amd64, linux/arm64
#
# Usage:
#   docker build -f Dockerfile.stack -t vsr-stack:latest .
#   docker buildx build -f Dockerfile.stack --platform linux/amd64,linux/arm64 -t vsr-stack:latest .
#
# Run:
#   docker run -d --name vsr \
#     -p 8801:8801 \
#     -p 8002:8002 \
#     -p 8700:8700 \
#     -p 3000:3000 \
#     -p 3001:3001 \
#     -p 5173:5173 \
#     -p 9090:9090 \
#     -p 9099:9099 \
#     -p 16686:16686 \
#     -v ./models:/app/models:ro \  # need run make download-models
#     vsr-stack:latest
# ============================================================================

# Build arguments for target architecture
ARG TARGETARCH
ARG TARGETOS=linux

# Version arguments for components
ARG ENVOY_VERSION=1.31.7
ARG PROMETHEUS_VERSION=2.53.0
ARG GRAFANA_VERSION=11.5.1
ARG JAEGER_VERSION=1.62.0
ARG MONGODB_VERSION=8.0.4
ARG CHATUI_VERSION=latest

# Stage 1: Rust library (candle-binding)
FROM rustlang/rust:nightly AS rust-builder

RUN apt-get update && apt-get install -y \
    make \
    build-essential \
    pkg-config \
    lld \
    clang \
    gcc-aarch64-linux-gnu \
    && rm -rf /var/lib/apt/lists/*

RUN rustup target add aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu

ENV CARGO_NET_GIT_FETCH_WITH_CLI=true
ENV CARGO_INCREMENTAL=1
ENV CARGO_PROFILE_RELEASE_LTO=thin
ENV CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
ENV RUSTFLAGS="-C link-arg=-fuse-ld=lld"

WORKDIR /app

COPY candle-binding/Cargo.toml ./candle-binding/
COPY candle-binding/Cargo.loc[k] ./candle-binding/
COPY tools/make/ tools/make/
COPY Makefile ./

RUN cd candle-binding && \
    mkdir -p src && \
    echo "fn main() {}" > src/lib.rs && \
    cargo build --release --no-default-features && \
    rm -rf src

COPY candle-binding/src/ ./candle-binding/src/

RUN cd candle-binding && \
    cargo clean && \
    cargo build --release --no-default-features

# Stage 2: semantic-router (Go)
FROM golang:1.24 AS go-router-builder

WORKDIR /app

RUN mkdir -p src/semantic-router
COPY src/semantic-router/go.mod src/semantic-router/go.sum src/semantic-router/
COPY candle-binding/go.mod candle-binding/semantic-router.go candle-binding/

RUN cd src/semantic-router && go mod download && \
    cd /app/candle-binding && go mod download

COPY src/semantic-router/ src/semantic-router/
COPY --from=rust-builder /app/candle-binding/target/release/libcandle_semantic_router.so /app/candle-binding/target/release/

ENV CGO_ENABLED=1
ENV LD_LIBRARY_PATH=/app/candle-binding/target/release
ENV GOOS=linux

RUN mkdir -p bin && cd src/semantic-router && \
    go build -ldflags="-w -s" -o ../../bin/router cmd/main.go

# Stage 3: Dashboard frontend (Node.js)
FROM node:20-alpine AS frontend-builder

WORKDIR /app/frontend
COPY dashboard/frontend/package.json dashboard/frontend/package-lock.json ./
COPY dashboard/frontend/tsconfig.json dashboard/frontend/tsconfig.node.json ./
COPY dashboard/frontend/vite.config.ts ./
COPY dashboard/frontend/src ./src
COPY dashboard/frontend/public ./public
COPY dashboard/frontend/index.html ./

RUN npm install --include=dev

# Stack: configure Open WebUI port for direct access
ENV VITE_OPENWEBUI_PORT=3001

RUN npm run build

# Stage 4: Dashboard backend (Go)
FROM golang:1.24 AS dashboard-builder

ARG TARGETARCH
ARG TARGETOS=linux

WORKDIR /app

COPY dashboard/backend/go.mod dashboard/backend/go.sum /app/dashboard/backend/
WORKDIR /app/dashboard/backend
RUN go mod download

COPY dashboard/backend/ /app/dashboard/backend/
RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -ldflags="-w -s" -o /app/dashboard-backend main.go

# Stage 5: chat-ui
FROM ghcr.io/huggingface/chat-ui-db:latest AS chatui-source

# Stage 5b: Open WebUI
FROM ghcr.io/open-webui/open-webui:main AS openwebui-source

# Stage 5c: Pipelines
FROM ghcr.io/open-webui/pipelines:main AS pipelines-source

# Stage 6a: Envoy
FROM envoyproxy/envoy:v1.31.7 AS envoy-source

# Stage 6b: MongoDB
FROM mongo:7 AS mongodb-source

# Stage 6c: Download binaries (Prometheus, Grafana, Jaeger)
FROM debian:testing AS downloader

ARG TARGETARCH
ARG PROMETHEUS_VERSION
ARG GRAFANA_VERSION
ARG JAEGER_VERSION
ARG MONGODB_VERSION

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    xz-utils \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /downloads

# Download Prometheus
RUN if [ "${TARGETARCH}" = "arm64" ]; then PROM_ARCH="arm64"; else PROM_ARCH="amd64"; fi && \
    curl -fsSL "https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-${PROM_ARCH}.tar.gz" \
        | tar -xzf - --strip-components=1 -C /downloads prometheus-${PROMETHEUS_VERSION}.linux-${PROM_ARCH}/prometheus prometheus-${PROMETHEUS_VERSION}.linux-${PROM_ARCH}/promtool

# Download Grafana
RUN if [ "${TARGETARCH}" = "arm64" ]; then GRAFANA_ARCH="arm64"; else GRAFANA_ARCH="amd64"; fi && \
    curl -fsSL "https://dl.grafana.com/oss/release/grafana-${GRAFANA_VERSION}.linux-${GRAFANA_ARCH}.tar.gz" \
        | tar -xzf - -C /downloads && \
    mv /downloads/grafana-v${GRAFANA_VERSION} /downloads/grafana || mv /downloads/grafana-${GRAFANA_VERSION} /downloads/grafana

# Download Jaeger
RUN if [ "${TARGETARCH}" = "arm64" ]; then JAEGER_ARCH="arm64"; else JAEGER_ARCH="amd64"; fi && \
    curl -fsSL "https://github.com/jaegertracing/jaeger/releases/download/v${JAEGER_VERSION}/jaeger-${JAEGER_VERSION}-linux-${JAEGER_ARCH}.tar.gz" \
        | tar -xzf - --strip-components=1 -C /downloads jaeger-${JAEGER_VERSION}-linux-${JAEGER_ARCH}/jaeger-all-in-one

# Stage 7: Final image
FROM debian:testing

LABEL maintainer="vLLM Semantic Router Team"
LABEL description="Stack image with semantic-router, dashboard, chat-ui, llm-katan, Envoy, MongoDB, Prometheus, Grafana, and Jaeger"

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

RUN apt-get update && apt-get install -y --no-install-recommends \
    supervisor \
    curl \
    wget \
    ca-certificates \
    libc6 \
    libstdc++6 \
    libgcc-s1 \
    gettext-base \
    adduser \
    libfontconfig1 \
    nodejs \
    npm \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /var/log/supervisor /var/run/supervisor

# Create application directories
RUN mkdir -p \
    /app/config \
    /app/lib \
    /app/models \
    /app/frontend \
    /app/chatui \
    /app/openwebui \
    /app/pipelines \
    /etc/envoy \
    /etc/prometheus \
    /etc/grafana/provisioning/datasources \
    /etc/grafana/provisioning/dashboards \
    /var/lib/grafana \
    /var/lib/prometheus \
    /var/lib/mongodb \
    /var/lib/openwebui \
    /opt/llmkatan-env \
    /etc/supervisor/conf.d

# Copy binaries
COPY --from=envoy-source /usr/local/bin/envoy /usr/local/bin/envoy

# Prometheus
COPY --from=downloader /downloads/prometheus /usr/local/bin/prometheus
COPY --from=downloader /downloads/promtool /usr/local/bin/promtool

# Grafana
COPY --from=downloader /downloads/grafana /opt/grafana

# Jaeger
COPY --from=downloader /downloads/jaeger-all-in-one /usr/local/bin/jaeger-all-in-one

# semantic-router
COPY --from=go-router-builder /app/bin/router /app/extproc-server
COPY --from=rust-builder /app/candle-binding/target/release/libcandle_semantic_router.so /app/lib/

# Dashboard
COPY --from=dashboard-builder /app/dashboard-backend /app/dashboard-backend
COPY --from=frontend-builder /app/frontend/dist /app/frontend

# MongoDB (from official Docker image)
COPY --from=mongodb-source /usr/bin/mongod /usr/local/bin/mongod

# chat-ui (HuggingChat) - from pre-built image
COPY --from=chatui-source /app /app/chatui

# Open WebUI - independent Python environment at /opt/openwebui-env
COPY --from=openwebui-source /usr/local /opt/openwebui-env
COPY --from=openwebui-source /app /app/openwebui

# Pipelines - independent Python environment at /opt/pipelines-env
COPY --from=pipelines-source /usr/local /opt/pipelines-env
COPY --from=pipelines-source /app /app/pipelines

# LLM-Katan - source files (will be installed in venv below)
COPY e2e-tests/llm-katan /app/llm-katan-src

# Install LLM-Katan in a virtual environment
# Using CPU-only PyTorch to save space (~2GB vs ~8GB with CUDA)
RUN python3 -m venv /opt/llmkatan-env && \
    /opt/llmkatan-env/bin/pip install --no-cache-dir --upgrade pip && \
    /opt/llmkatan-env/bin/pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu && \
    /opt/llmkatan-env/bin/pip install --no-cache-dir -r /app/llm-katan-src/requirements.txt && \
    /opt/llmkatan-env/bin/pip install --no-cache-dir /app/llm-katan-src && \
    rm -rf /app/llm-katan-src

# vllm semantic router pipeline config (stack version with localhost:8801)
COPY deploy/stack/vllm_semantic_router_pipe.py /app/pipelines/vllm_semantic_router_pipe.py

# Configuration files
COPY deploy/stack/config.stack.yaml /app/config/config.yaml

# Envoy config
COPY deploy/stack/envoy.template.yaml /etc/envoy/envoy.template.yaml

# Prometheus config
COPY deploy/stack/prometheus.yaml /etc/prometheus/prometheus.yml

# Grafana provisioning
COPY deploy/stack/grafana-datasource.yaml /etc/grafana/provisioning/datasources/datasource.yaml
COPY deploy/stack/grafana-dashboard.yaml /etc/grafana/provisioning/dashboards/dashboard.yaml
COPY deploy/docker-compose/addons/llm-router-dashboard.json /etc/grafana/provisioning/dashboards/

# Supervisor config
COPY deploy/stack/supervisord.stack.conf /etc/supervisor/supervisord.conf

# Entrypoint
COPY deploy/stack/entrypoint-stack.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh /app/extproc-server /app/dashboard-backend

# Environment variables
ENV LD_LIBRARY_PATH=/app/lib

# Application config
ENV CONFIG_FILE=/app/config/config.yaml

# Envoy
ENV ENVOY_LISTEN_PORT=8801
ENV ENVOY_ADMIN_PORT=19000
ENV EXTPROC_HOST=localhost
ENV EXTPROC_PORT=50051

# Dashboard
ENV DASHBOARD_PORT=8700

# Grafana
ENV GF_PATHS_HOME=/opt/grafana
ENV GF_PATHS_DATA=/var/lib/grafana
ENV GF_PATHS_PROVISIONING=/etc/grafana/provisioning
ENV GF_SECURITY_ADMIN_USER=admin
ENV GF_SECURITY_ADMIN_PASSWORD=admin

# Jaeger
ENV COLLECTOR_OTLP_ENABLED=true

# MongoDB
ENV MONGODB_DATA_PATH=/var/lib/mongodb

# chat-ui (HuggingChat)
ENV CHATUI_PORT=5173
ENV MONGODB_URL=mongodb://127.0.0.1:27017
ENV MONGODB_DB_NAME=chat-ui
ENV OPENAI_BASE_URL=http://localhost:8801/v1
ENV OPENAI_API_KEY=placeholder
ENV PUBLIC_APP_NAME=HuggingChat
ENV PUBLIC_APP_ASSETS=chatui
ENV COOKIE_SECURE=false
ENV COOKIE_NAME=hf-chat
ENV COOKIE_SAMESITE=lax
ENV APP_BASE_URL=http://localhost:5173

# Open WebUI
ENV OPENWEBUI_PORT=3001
ENV OPENWEBUI_DATA_DIR=/var/lib/openwebui
ENV OPENAI_API_BASE_URL=http://localhost:9099

# Pipelines
ENV PIPELINES_PORT=9099

# LLM-Katan (lightweight LLM server)
ENV LLMKATAN_PORT=8002
ENV LLMKATAN_MODEL=/app/models/Qwen/Qwen3-0.6B
ENV LLMKATAN_SERVED_MODEL_NAME=qwen3

# Ports:
# 8801  - Envoy HTTP proxy (main API endpoint)
# 19000 - Envoy admin interface
# 50051 - semantic-router gRPC
# 8080  - semantic-router HTTP (health/metrics)
# 8700  - Dashboard
# 9090  - Prometheus
# 3000  - Grafana
# 16686 - Jaeger UI
# 4317  - Jaeger OTLP gRPC
# 5173  - chat-ui (HuggingChat)
# 3001  - Open WebUI
# 9099  - Pipelines
# 8002  - LLM-Katan
EXPOSE 8801 19000 50051 8080 8700 9090 3000 16686 4317 5173 3001 9099 8002

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8080/health && curl -f http://localhost:8700/healthz || exit 1

WORKDIR /app

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["supervisord", "-c", "/etc/supervisor/supervisord.conf", "-n"]
