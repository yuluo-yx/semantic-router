# Category-Level PII Detection Example
# This example demonstrates how to configure PII detection at the category level
# Different categories can have different PII detection settings and thresholds based on their sensitivity

# Global PII detection configuration (can be overridden per category)
classifier:
  pii_model:
    model_id: "models/pii_classifier_modernbert-base_model"
    threshold: 0.7  # Global default threshold - can be overridden per category
    use_cpu: true
    pii_mapping_path: "models/pii_classifier_modernbert-base_model/pii_type_mapping.json"

  category_model:
    model_id: "models/mom-domain-classifier"
    use_modernbert: true
    threshold: 0.6
    use_cpu: true
    category_mapping_path: "models/mom-domain-classifier/category_mapping.json"

# Categories define domain metadata only (no routing logic)
categories:
  - name: healthcare
    description: "Healthcare and medical queries"
    mmlu_categories: ["healthcare"]
  - name: finance
    description: "Financial and banking queries"
    mmlu_categories: ["finance"]
  - name: customer_support
    description: "Customer support and general inquiries"
    mmlu_categories: ["customer_support"]
  - name: code_generation
    description: "Internal code generation and development tools"
    mmlu_categories: ["code_generation"]
  - name: documentation
    description: "Public documentation and help articles"
    mmlu_categories: ["documentation"]
  - name: testing
    description: "Testing and quality assurance queries"
    mmlu_categories: ["testing"]
  - name: general
    description: "General queries that don't fit into specific categories"
    mmlu_categories: ["general"]

# Decisions define routing logic with domain-based conditions
strategy: "priority"

decisions:
  # High-security category: Strict PII detection with high threshold
  - name: "healthcare_decision"
    description: "Healthcare and medical queries"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "healthcare"
    modelRefs:
      - model: "secure-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a healthcare assistant. Handle all personal information with utmost care."
      - type: "pii"
        configuration:
          enabled: true
          threshold: 0.9
          pii_types_allowed: ["GPE", "ORGANIZATION"]

  # Financial category: Very strict PII detection
  - name: "finance_decision"
    description: "Financial and banking queries"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "finance"
    modelRefs:
      - model: "secure-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a financial advisor. Never store or log any PII information."
      - type: "pii"
        configuration:
          enabled: true
          threshold: 0.95
          pii_types_allowed: ["GPE", "ORGANIZATION"]

  # Customer support: Balanced threshold
  - name: "customer_support_decision"
    description: "Customer support and general inquiries"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "customer_support"
    modelRefs:
      - model: "general-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a friendly customer support agent. Be cautious with customer information."
      - type: "pii"
        configuration:
          enabled: true
          threshold: 0.8
          pii_types_allowed: []

  # Internal tools: Relaxed threshold (trusted environment)
  - name: "code_generation_decision"
    description: "Internal code generation and development tools"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "code_generation"
    modelRefs:
      - model: "general-llm"
        use_reasoning: true
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a code generation assistant for internal developers."
      - type: "pii"
        configuration:
          enabled: true
          threshold: 0.5
          pii_types_allowed: []

  # Public documentation: Lower threshold for broader detection
  - name: "documentation_decision"
    description: "Public documentation and help articles"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "documentation"
    modelRefs:
      - model: "general-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a documentation assistant. Help create clear public documentation."
      - type: "pii"
        configuration:
          enabled: true
          threshold: 0.6
          pii_types_allowed: []

  # Testing category: Disable PII detection
  - name: "testing_decision"
    description: "Testing and quality assurance queries"
    priority: 100
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "testing"
    modelRefs:
      - model: "general-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a QA assistant helping with test scenarios."
      - type: "pii"
        configuration:
          enabled: false
          pii_types_allowed: []

  # Default category: Uses global setting
  - name: "general_decision"
    description: "General queries that don't fit into specific categories"
    priority: 50
    rules:
      operator: "AND"
      conditions:
        - type: "domain"
          name: "general"
    modelRefs:
      - model: "general-llm"
        use_reasoning: false
    plugins:
      - type: "system_prompt"
        configuration:
          system_prompt: "You are a helpful assistant."
      - type: "pii"
        configuration:
          enabled: true
          pii_types_allowed: []

# Model configuration
model_config:
  "secure-llm":
    preferred_endpoints: ["secure-endpoint"]

  "general-llm":
    preferred_endpoints: ["general-endpoint"]

# Default model for fallback
default_model: general-llm

# vLLM endpoints configuration
vllm_endpoints:
  - name: "secure-endpoint"
    address: "127.0.0.1"
    port: 8000
    weight: 1

  - name: "general-endpoint"
    address: "127.0.0.1"
    port: 8001
    weight: 1

# Usage Notes:
# =============
# 1. Global Settings:
#    - classifier.pii_model: Configures the PII detection model and default threshold
#    - threshold: Sets the default detection threshold (0.0-1.0) for all categories
# 2. Category Overrides:
#    - pii_enabled: Override global enabled/disabled setting per category
#    - pii_threshold: Override global threshold per category
# 3. Inheritance:
#    - If pii_enabled is not specified, inherits from global (enabled if pii_model is configured)
#    - If pii_threshold is not specified, inherits from global classifier.pii_model.threshold
# 4. Threshold Tuning Guidelines:
#    - Higher threshold (0.85-0.95): Stricter detection, fewer false positives, may miss subtle PII
#      * Use for: Healthcare, Finance, Legal categories where precision is critical
#      * Risk: May miss some PII entities with lower confidence
#    - Medium threshold (0.65-0.85): Balanced detection, good for most use cases
#      * Use for: Customer support, HR, General business queries
#      * Risk: Moderate false positive/negative rate
#    - Lower threshold (0.4-0.65): More sensitive detection, catches more PII, higher false positive rate
#      * Use for: Public content, Documentation, Code generation (to avoid false positives)
#      * Risk: Higher false positive rate, especially with technical content
# 5. PII Type Considerations:
#    - Different PII types have different consequences:
#      * Critical (SSN, Credit Card, Passwords): Use threshold 0.9+
#      * Sensitive (Email, Phone, Address): Use threshold 0.75-0.9
#      * General (Names, Organizations, Dates): Use threshold 0.6-0.75
#    - Consider using different thresholds per category based on expected PII types
# 6. Use Cases by Category:
#    - Healthcare: High threshold (0.9+) to avoid false positives on medical terms
#    - Finance: Very high threshold (0.95+) for critical financial PII
#    - Customer Support: Medium-high threshold (0.8) for balanced protection
#    - Code/Technical: Lower threshold (0.5-0.6) to reduce false positives on code artifacts
#    - Public Content: Lower threshold (0.6) to catch more potential PII before publication
#    - Testing: Disabled to avoid interference with test data
# 7. Security Best Practices:
#    - Enable PII detection by default (configure classifier.pii_model)
#    - Only disable or use very low thresholds for specific categories where risk is managed
#    - Consider the consequences of PII exposure on a per-category basis
#    - Monitor false positive and false negative rates to tune thresholds appropriately
#    - Combine with model-level PII policies (pii_policy) for defense in depth
#    - Use different thresholds for different sensitivity levels:
#      * Public-facing categories: Higher thresholds to reduce false positives
#      * Internal categories: Lower thresholds for broader detection
#      * Critical categories: Highest thresholds for precision
# 8. Testing and Tuning:
#    - Start with conservative (higher) thresholds and adjust based on false positive rate
#    - Monitor PII detection metrics to understand category-specific patterns
#    - Test with representative data for each category to validate threshold settings
#    - Consider A/B testing different thresholds to find optimal values
